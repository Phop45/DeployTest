<head>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" />
  
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.25.0/date-fns.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap");
  
      * {
        font-family: "Kanit", sans-serif;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
  
      :root {
        --body-color: #e4e9f7;
        --sidebar-colot: #fff;
        --primary-color-light: #f6f5f7;
        --toggle-color: #ddd;
        --text-color: #707070;
        --line: #d7d9dd;
  
        --color1: #7952b3;
        --color2: #a788d4;
        --color3: #e4e9f6;
        --text: #37352f;
  
        --text2: #515761;
        --light: #37352fa6;
        --more-light: #222220d7;
        --notYet: #b5c0d0;
  
        --cancle: #ff004d;
      }
  
      .contant {
        background-color: white;
        margin: 20px 20px 20px 130px;
        border-radius: 20px;
        display: flex;
        flex-direction: column;
        height: 100%;
      }
  
      .SubName {
        padding: 30px 0 20px 50px;
        font-size: 40px;
      }
  
      .nav-tabs {
        padding-left: 50px;
        font-size: 16px;
        font-weight: 400;
      }
  
      .task-content {
        display: flex;
        flex-direction: row;
        height: 90vh;
      }
  
      .task-content .right-bar {
        display: flex;
        flex-direction: column;
        height: 100%;
        width: calc(35% - 10px);
        margin: 30px 0 20px 50px;
        gap: 40px;
      }
  
      .task-content .right-bar .shortcut {
        display: flex;
        flex-direction: column;
        height: fit-content;
        width: 100%;
      }
  
      #SubDescription {
        padding: 10px 20px;
        border: 1px solid rgba(55, 53, 47, 0.16);
        border-radius: 5px;
        width: 96%;
        max-height: 20vh;
        min-height: 20vh;
        overflow: scroll;
      }
  
      #sub-datil {
        display: flex;
        flex-direction: row;
        align-items: center;
      }
  
      #sub-datil p {
        margin: 0;
      }
  
      #sub-datil p#text {
        font-weight: 600;
        padding: 10px;
        padding-bottom: 0;
        width: 45%;
        color: var(--color1);
      }
  
      #sub-datil p#detail {
        width: max-content;
        padding: 10px;
        padding-bottom: 0;
        width: 60%;
        border-bottom: 1px solid rgba(55, 53, 47, 0.16);
      }
  
      .shortcut h1 {
        font-size: 1.25em;
        padding-bottom: 10px;
        padding-left: 10px;
        border-bottom: 1px solid rgba(55, 53, 47, 0.16);
        margin-bottom: 0;
      }
  
      .shortcut .short-link {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 15px;
      }
  
      .shortcut a {
        display: flex;
        align-items: center;
        text-decoration: none;
        min-width: 50px;
        max-width: calc(100% - 28px);
        height: 40px;
        white-space: nowrap;
        justify-content: flex-start;
        color: black;
        border: 1px solid rgba(55, 53, 47, 0.16);
        border-radius: 5px;
        font-size: 14px;
        font-weight: 200;
        padding: 8px 12px;
        text-overflow: ellipsis;
        overflow: hidden;
        transition: 0.3s;
      }
  
      .shortcut a:hover {
        background-color: var(--primary-color);
        color: white;
        font-weight: 400;
      }
  
      .shortcut i {
        padding-right: 15px;
        font-size: 20px;
      }
  
      .task-content {
        flex: 1;
        overflow-y: hidden;
        margin-bottom: 50px;
      }
  
      .dashboard {
        display: flex;
        flex-direction: column;
        padding: 0 50px 0 50px;
        gap: 60px;
        width: 100%;
      }
  
      .sidebar.close {
        z-index: 0;
      }
  
      .sidebar-popup {
        width: 600px;
        height: 100vh;
        background-color: white;
        position: fixed;
        top: 0;
        right: -600px;
        transition: right 1s ease;
        z-index: 1;
      }
  
      .dashboard {
        display: grid;
        grid-template-areas:
          'top-dash'
          'last-dash';
        gap: 10px;
      }
  
      .top-dash {
        width: 100%;
        height: 350px;
        margin-top: 50px;
        display: flex;
      }
  
      .status-task {
        margin: 0 4% 0 0;
        width: 28%;
        border: #E9EBEF solid 2px;
        border-radius: 20px;
        position: relative;
        display: flex;
        flex-direction: column;
        justify-content: center;
      }
  
      .status-task h5 {
        align-items: start;
        margin: 20px 0 0 30px;
      }
  
      .pie {
        padding: 0 20px 20px 20px;
        width: 100%;
        height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
  
      .workload-task {
        margin: 0 4% 0 0;
        width: 68%;
        border: #E9EBEF solid 2px;
        border-radius: 20px;
        position: relative;
      }
  
      .workload-task h5 {
        margin: 20px 0 0 30px;
      }
  
      .maxgraph {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 20px;
      }
  
      .member-workload {
        display: flex;
        align-items: center;
        justify-content: space-between;
        border: 1px solid #E9EBEF;
        border-radius: 5px;
        padding: 10px;
        font-size: 14px;
        position: relative;
      }
  
      .progress-bar {
        height: 20px;
        border-radius: 5px;
        position: relative;
        width: 80%;
        background-color: #E9EBEF;
      }
  
      .progress-bar span {
        display: block;
        height: 100%;
        background-color: #9BCF53;
        border-radius: 5px;
      }
  
      .progress-text {
        font-weight: bold;
        color: #37352f;
        padding-left: 10px;
        width: 20%;
      }
  
      .member-workload {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        border: 1px solid #E9EBEF;
        border-radius: 5px;
        padding: 10px;
        font-size: 14px;
        position: relative;
        gap: 10px;
        /* เพิ่มช่องว่างระหว่างรูปภาพกับแถบ */
      }
  
      .profile-picture {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid #E9EBEF;
      }
  
      .progress-bar {
        height: 20px;
        border-radius: 5px;
        position: relative;
        width: 90%;
        /* ปรับขนาดแถบ */
        background-color: #E9EBEF;
      }
  
      .progress-text {
        font-weight: bold;
        color: #37352f;
        padding-left: 10px;
        width: 5%;
      }
  
      .last-dash {
        width: 100%;
        margin: 50px 0;
        display: flex;
      }
  
      .left-graph {
        width: 27%;
        margin: 0 4% 0 0;
      }
  
      .left-graph-sub {
        height: 350px;
        border: #E9EBEF solid 2px;
        border-radius: 20px;
        position: relative;
        display: flex;
        flex-direction: column;
      }
  
      .left-graph-sub h5 {
        margin: 20px 0 0 30px;
      }
  
      .left-graph-sub .priority-graph {
        padding: 0 20px 0 20px;
        width: 100%;
        height: 300px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
  
      .sum-work {
        width: 100%;
        display: flex;
        flex-direction: column;
      }
  
      .sum-work #sum-work {
        padding: 10px;
        margin: 20px 0;
        border: #E9EBEF solid 2px;
        border-radius: 20px;
        display: flex;
      }
  
      .sum-work img {
        width: 50px;
      }
  
      .sum-work .textwork {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        position: relative;
      }
  
      .sum-work label {
        margin-left: 10px;
      }
  
      .count {
        font-weight: bold;
        position: absolute;
        right: 0;
        /* ติดขอบขวาของ container */
      }
  
      .right-table {
        margin: 0 4% 0 0;
        width: 68%;
        border: #E9EBEF solid 2px;
        border-radius: 20px;
        position: relative;
      }
  
      .right-table .work-table {
        padding: 20px;
        display: contents;
        height: 100%;
      }
  
  
      .right-table h5 {
        margin: 20px 0 0 30px;
      }
  
      .right-table img {
        margin: 10px;
        width: 90%;
        object-fit: cover;
      }
    </style>
  </head>
  
  <div class="contant">
    <h1 class="SubName"><%= spaces.SpaceName %></h1>
    <%- include('../task/task_component/task-navbar.ejs') %>
    <div class="dashboard">
      <div class="top-dash">
        <div class="status-task">
          <h5>สถานะของงาน</h5>
          <div class="pie">
            <canvas id="statusChart"></canvas>
          </div>
        </div>
        <div class="workload-task">
          <h5>ปริมาณงานของสมาชิก</h5>
          <div class="maxgraph">
            <div class="member-workload">
              <img src="/img/images.jpeg" alt="User 1" class="profile-picture"> <!-- รูปภาพของผู้ใช้ -->
              <div class="progress-bar">
                <span style="width: 60%;"></span> <!-- เปอร์เซ็นต์งานที่เสร็จ -->
              </div>
              <div class="progress-text">60%</div> <!-- แสดงเปอร์เซ็นต์งานที่เสร็จ -->
            </div>
  
            <div class="member-workload">
              <img src="/img/images.jpeg" alt="User 2" class="profile-picture">
              <div class="progress-bar">
                <span style="width: 80%;"></span>
              </div>
              <div class="progress-text">80%</div>
            </div>
  
            <div class="member-workload">
              <img src="/img/images.jpeg" alt="User 3" class="profile-picture">
              <div class="progress-bar">
                <span style="width: 45%;"></span>
              </div>
              <div class="progress-text">45%</div>
            </div>
          </div>
  
        </div>
      </div>
      <div class="last-dash">
        <div class="left-graph">
          <div class="left-graph-sub">
            <h5>การแบ่งลำดับความสำคัญ</h5>
            <div class="priority-graph">
              <canvas id="priorityChart" width="300" height="290"></canvas>
            </div>
          </div>
          <div class="sum-work">
            <div class="allwork" id="sum-work">
                <img src="/img/allwork.jpg" alt="งานทั้งหมด">
              <div class="textwork">
                <label>งานทั้งหมด</label>
                <div class="count"><%= tasks.length %><span>งาน</span></div>
  
              </div>
            </div>
            <div class="subtask" id="sum-work">
                <img src="/img/subtask.jpg" alt="งานย่อยทั้งหมด">
              <div class="textwork">
                <label>งานย่อยทั้งหมด</label>
                <div count><%= subtasksCount %><span>งาน</span></div>
              </div>
            </div>
            <div class="succeedtask" id="sum-work">
                <img src="/img/succeedtask.jpg" alt="งานที่เสร็จสิ้น">
              <div class="textwork">
                <label>งานที่เสร็จสิ้น</label>
                <div class="count"><%= completedTasksCount %><span>งาน</span></div>
              </div>
            </div>
          </div>
        </div>
  
        <div class="right-table">
          <h5>ลิสต์งานทั้งหมดภายในพื้นที่</h5>
          <div class="work-table"> <img src="/img/task-dash.jpg" alt="Task Dashboard">
          </div>
        </div>
      </div>
    </div>
  </div>
  <%- include('../task/task_component/dashboard_addPopup.ejs') %>
  <script src="public/script/taskScript/task-dashboard.js"></script>
  <script src="/script/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    document.addEventListener('DOMContentLoaded', function () {
        const statusData = {
            labels: ['กำลังทำ', 'เสร็จสิ้น', 'แก้ไข'],
            datasets: [{
              data: [
                <%= statusCounts.working %>,
                <%= statusCounts.complete %>,
                <%= statusCounts.fix %>
              ],
              backgroundColor: ['#B4B4B8', '#9BCF53', '#FF6868'],
              hoverBackgroundColor: ['#C7C8CC', '#BFEA7C', '#FF8F8F']
            }]
          };
        
          // ตรวจสอบว่าข้อมูลทั้งหมดเป็น 0 หรือไม่
          function isDataEmpty(dataArray) {
            return dataArray.every(value => value === 0);
          }
        
          // สร้างกราฟ
          const ctxStatus = document.getElementById('statusChart').getContext('2d');
          const chartConfig = {
            type: 'pie', // เปลี่ยนเป็น Pie Chart
            data: statusData,
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: 'top',
                },
                tooltip: {
                  callbacks: {
                    label: function(tooltipItem) {
                      return `สถานะ: ${tooltipItem.label} (${tooltipItem.raw})`;
                    }
                  }
                }
              }
            }
          };
        
          // หากข้อมูลเป็น 0 ทั้งหมด แสดงข้อความบอกว่าไม่มีงาน
          if (isDataEmpty(statusData.datasets[0].data)) {
            chartConfig.data = {
              labels: ['ไม่มีข้อมูล'],
              datasets: [{
                data: [1], // ค่าข้อมูลกราฟที่ทำให้แสดงวงกลมว่าง
                backgroundColor: ['#E0E0E0'], // สีของกราฟที่ไม่มีข้อมูล
                hoverBackgroundColor: ['#E0E0E0']
              }]
            };
            chartConfig.options.plugins.tooltip.enabled = false; // ปิด tooltip เพราะไม่มีข้อมูลจริง
          }
        
          new Chart(ctxStatus, chartConfig);
          const priorityData = {
            labels: ['ยังไม่ได้กำหนด', 'สูง', 'ปกติ', 'ต่ำ'],
            datasets: [{
              label: 'งาน',
              data: [4, 2, 1, 3], // จำนวนงานในแต่ละระดับ
              backgroundColor: ['#d3d3d3', '#ff4c4c', '#ffa500', '#800080'], // สีของแต่ละระดับ
              borderColor: ['#c0c0c0', '#e60000', '#cc8400', '#660066'], // สีขอบ
              borderWidth: 1
            }]
          };
        
          const priorityConfig = {
            type: 'bar',
            data: priorityData,
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  max: 10
                },
                x: {
                  ticks: {
                    font: {
                      size: 9 // กำหนดขนาดฟอนต์สำหรับป้ายชื่อในแกน X
                    }
                  }
                }
              },
              plugins: {
                legend: {
                  display: false // ซ่อนคำอธิบายใต้กราฟ
                }
              }
            }
          };
        
          const ctxPriority = document.getElementById('priorityChart').getContext('2d');
          ctxStatus.canvas.height = 250; // กำหนดความสูงของกราฟ
          new Chart(ctxPriority, priorityConfig);
    });
  </script>