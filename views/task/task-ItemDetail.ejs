<link rel="stylesheet" href="/css/taskCss/list-itemDetail.css">
<body>
    <div class="content">
        <div class="topOption">
            <div class="breadcomes">
                <a href="/space">พื้นที่</a> 
                    <span>/</span>
                <a href="/space/item/<%= spaceId %>">แดชบอร์ด</a>
                    <span>/</span>
                <a href="/space/item/<%= spaceId %>/task_board">บอร์ดงาน</a>
                    <span>/</span>
                <a class="active-detail">
                    <%= taskNames %>
                </a>
            </div>
            <div class="btn-option">
                <p>สร้างเมื่อวันที่ <span id="createAt"> <%= createdAt %> </span></p>
                <a href="/space/item/<%= spaceId %>/task_board" id="close_btn_link">
                    <span id="close_btn">&times;</span>
                  </a>
            </div>
        </div>

        <div class="taskSection">
            <div class="subtask">
                <div class="textTopic"> <h1>งานย่อยภายในงาน</h1> </div>
                <div class="subtaskItem">
                    <ul class="item" id="subtaskList">
                        <% inProgressSubtasks.forEach((subtask) => { %>
                            <li class="itemDetail" data-subtask-id="<%= subtask._id %>" onclick="showSubtaskFullView('<%= subtask._id %>')">
                                <i class="fa-regular fa-circle-dot"></i>
                                <span class="subName"><%= subtask.subtask_Name %></span>
                                <div class="subtask-options">
                                    <a class="subtask-nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="bx bx-dots-horizontal-rounded"></i>
                                    </a>
                                    <ul class="dropdown-menu">
                                        <li>
                                            <a class="dropdown-item rename-subtask" href="#">
                                                <i class="fa-solid fa-pen"></i> เปลี่ยนชื่อ
                                            </a>
                                        </li>
                                        <li>
                                            <a class="dropdown-item delete-subtask" href="#" style="color: red;">
                                                <i class="fa-solid fa-trash" style="color: red;"></i> ลบงานย่อย
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </li>
                        <% }); %>
                        <li class="itemDetail" id="subtaskForm" style="display: none;"> 
                            <form id="addSubtaskForm">
                                <i class="fa-regular fa-circle-dot"></i>
                                <input type="hidden" id="taskId" value="<%= task._id %>">
                                <input type="text" id="addSubtask" placeholder="Subtask Name" required>
                                <input type="hidden" id="mainTaskDueDate" value="<%= mainTaskDueDate.toISOString() %>"> 
                            </form>
                        </li>
                    </ul>

                    <div class="addSubtask">
                        <button id="addSub-btn">
                            <span>+ เพิ่มงานย่อยใหม่</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="detail">
                <form id="updateTaskForm" action="/updateTask" method="post" class="updateTaskForm1">
                    <input type="hidden" id="taskId" name="taskId" value="<%= task._id %>">
                    <input type="hidden" id="taskPriority" name="taskPriority" value="<%= task.taskPriority %>">
                    <input type="hidden" id="taskName" name="taskName" value="<%= taskNames %>">
                    <input type="hidden" id="taskDetail" name="taskDetail" value="<%= taskDetail %>">
                    <input type="hidden" id="taskStatus" name="taskStatuses" value="<%= task.taskStatuses %>">

                    <!-- Task Name -->
                     <div class="firstSec">
                        <div class="nameSec">
                            <h1 class="taskName" id="taskName-text" onclick="editTaskName()">
                                <%= taskNames %> 
                            </h1>
                            <input type="text" id="taskName" name="taskName" value="<%= taskNames %>" style="display: none;" onblur="saveTaskName()">
                            <span id="notiAlert" style="font-size: 14px; color: #FF004D; display: none; margin-top: 5px;">
                                * กรุณากรอกชื่อโดยไม่ใช้อักขระพิเศษ หรือค่าว่าง
                            </span>
                       </div>
                       <div class="checkTask">
                            <button type="button" id="checkTask" onclick="checkWork()">
                                <span>ส่งงาน</span>
                                <i class="fa-solid fa-paper-plane"></i>
                            </button>
                        </div>
                     </div>
                       
                    <!-- Task Name -->

                    <!-- Task Detail -->
                    <div class="detailSec">
                        <div class="grid-container">
                            <div class="grid-item topic">
                                <div class="detail-name">
                                    <i class="fa-solid fa-circle-half-stroke"></i>
                                    สถานะ
                                </div>
                                <div class="detail-data" id="detail-data-status">
                                    <div class="status-div" data-status="<%= taskStatuses %>">
                                        <i class="fa-solid fa-spinner spinner-icon" style="display: none;"></i>
                                        <span class="status-text"><%= taskStatuses %></span>
                                    </div>
                                </div>
                            </div>
                            <div class="grid-item topic">
                                <div class="detail-name">
                                    <i class="fa-regular fa-circle-user"></i>
                                    ผู้รับผิดชอบ
                                </div>
                                <div class="detail-data">
                                    <img src="<%= userImage %>" width="40px" height="40px">
                                </div>
                            </div>
                    
                            <form action="/updateDueDate" method="POST" id="updateDueDateForm">
                                <div class="grid-item topic">
                                    <div class="detail-name">
                                        <i class="fa-regular fa-calendar-check"></i> วันครบกำหนด
                                    </div>
                                    <div class="detail-data clickable" id="dueDateText">
                                        <%= dueDate ? new Date(dueDate).toLocaleDateString('th-TH', { day: 'numeric' , month: 'long' ,
                                            year: 'numeric' }) : 'ไม่มีวันครบกำหนด' %>
                                    </div>
                                    <!-- Visible input for flatpickr to work on but hidden -->
                                    <input type="text" id="dueDateInput" name="dueDate"
                                        value="<%= dueDate && !isNaN(new Date(dueDate).getTime()) ? 
                                                            new Date(new Date(dueDate).getTime() - new Date(dueDate).getTimezoneOffset() * 60000).toISOString().split('T')[0] : '' %>"
                                        style="visibility: hidden; position: absolute;">
                                    <input type="hidden" name="taskId" value="<%= task._id %>">
                                </div>
                            </form>
                    
                            <div class="grid-item topic">
                                <div class="detail-name">
                                    <i class="fa-regular fa-flag"></i>
                                    ระดับความสำคัญ
                                </div>
                                <div class="detail-data">
                                    <div class="nav-item dropdown taskPriority">
                                        <a class="nav-link dropdown-toggle" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" style="margin-left: -10px;">
                                            <%= task.taskPriority %>
                                        </a>
                                        <ul class="dropdown-menu" aria-labelledby="navbarDropdown">
                                            <li class="item">
                                                <a class="dropdown-item task-priority priority-urgent" href="#" data-priority="ด่วน">
                                                    <i class="fa-solid fa-flag"></i> <span class="text">ด่วน</span>
                                                    <div class="pri_dis">งานที่มีลำดับความสำคัญสูง...</div>
                                                </a>
                                            </li>
                                            <li class="item">
                                                <a class="dropdown-item task-priority priority-normal" href="#" data-priority="ปกติ">
                                                    <i class="fa-solid fa-flag"></i> <span class="text">ปกติ</span>
                                                    <div class="pri_dis">งานที่มีลำดับความสำคัญปานกลาง...</div>
                                                </a>
                                            </li>
                                            <li class="item">
                                                <a class="dropdown-item task-priority priority-low" href="#" data-priority="ต่ำ">
                                                    <i class="fa-solid fa-flag"></i> <span class="text">ต่ำ</span>
                                                    <div class="pri_dis">งานที่มีลำดับความสำคัญต่ำ...</div>
                                                </a>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                    
                            <div class="grid-item topic">
                                <div class="detail-name">
                                    <i class="fa-regular fa-clock" style="margin-right: 5px;"></i>
                                    เวลาครบกำหนด
                                </div>
                                <div class="detail-data">
                                    <form action="/updateDueTime" method="POST" id="updateDueTimeForm">
                                        <div id="info">
                                            <div class="custom-select-container">
                                                <select id="dueTimeSelect" name="dueTime">
                                                    <option value="" <%=!dueTime ? 'selected' : '' %>>ตลอดทั้งวัน</option>
                                                    <% for (let hour=0; hour < 24; hour++) { let hourString=hour < 10 ? '0' + hour : hour;
                                                        let isSelected00=dueTime===`${hourString}:00` ? 'selected' : '' ; let
                                                        isSelected30=dueTime===`${hourString}:30` ? 'selected' : '' ; %>
                                                        <option value="<%= hourString %>:00" <%=isSelected00 %>><%= hourString %>:00
                                                        </option>
                                                        <option value="<%= hourString %>:30" <%=isSelected30 %>><%= hourString %>:30
                                                        </option>
                                                        <% } %>
                                                </select>
                                            </div>
                                            <input type="hidden" name="taskId" value="<%= task._id %>">
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div class="grid-item topic">
                                <div class="detail-name">
                                    <i class="fa-solid fa-tags"></i>
                                    Tags
                                </div>
                                <div class="detail-data">
                                    <span class="tag">homework</span>
                                    <span class="tag">more</span>
                                    <span class="tag">+1</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Task Detail -->

                    <!-- Task Description -->
                        <div class="descriptSec">
                            <div class="description-box">
                                <textarea name="taskDescription" id="taskDescription" placeholder="เพิ่มคำอธิบายของงานได้ที่นี่..."></textarea>
                                <div class="expand-icon" onclick="openFullView()">
                                    <i class="fa-solid fa-expand"></i>
                                </div>
                            </div>
                        </div>
                    <!-- Task Description -->
                </form>


                <div class="attachments-section">
                    <h3><i class="fa-solid fa-paperclip" style="padding-right: 10px;"></i> แนบไฟล์</h3>
                    <form action="/uploadDocument/<%= task._id %>?spaceId=<%= spaceId %>" method="POST" enctype="multipart/form-data"
                        id="uploadInput">
                        <div class="attachment">
                            <div id="attach">
                                <label class="attachmentLabel" for="fileUpload">เลือกไฟล์</label>
                                <input type="file" id="fileUpload" name="documents" multiple
                                    accept=".jpg, .jpeg, .png, .docx, .doc, .pdf" />
                                <span id="fileName">ไม่ได้เลือกไฟล์ใด</span>
                            </div>
                            <button type="submit" class="btn btn-primary">อัพโหลด</button>
                        </div>
                        <p class="file_input_help"" id=" file_input_help" style="margin-top: 10px; ">
                            jpg, jpeg, png, docx, doc, pdf (ไม่เกิน 5 MB).
                        </p>
                    </form>
                    <div class="fileItemSec">
                        <% if (attachments.length > 0) { %>
                            <ul id="fileItemlist">
                                <% task.attachments.forEach(attachment => { %>
                                    <li id="fileItem">
                                        <a href="<%= attachment.path %>" target="_blank" download>
                                            <% const ext = attachment.originalName.split('.').pop().toLowerCase(); %>
                                            <% if (ext === 'pdf') { %>
                                                <i class="fa-solid fa-file-pdf" style="color: #d9534f;"></i>
                                            <% } else if (['doc', 'docx'].includes(ext)) { %>
                                                <i class="fa-solid fa-file-word" style="color: #337ab7;"></i>
                                            <% } else if (['jpg', 'jpeg', 'png'].includes(ext)) { %>
                                                <i class="fa-solid fa-file-image" style="color: #5cb85c;"></i>
                                            <% } else { %>
                                                <i class="fa-solid fa-file" style="color: #6c757d;"></i>
                                            <% } %>
                                            <div class="fileName">
                                                <span class="file-text"><%= attachment.originalName %></span>
                                            </div>
                                        </a>
                                    </li>
                                <% }) %>
                            </ul>
                            
                          <% } else { %>
                            <p>ไม่มีไฟล์ที่อัปโหลด</p>
                          <% } %>
                          
                    </div>
                
                </div>

                <div class="subtaskSec">
                    <h1 class="subText"><i class="fa-solid fa-list-check" style="padding-right: 10px;"></i> งานย่อย</h1>
                
                    <!-- Table for Subtasks (hidden initially if no data) -->
                    <div id="subtaskTableContainerNew" class="subtask-table" style="display: none;">
                        <table id="subtaskTableNew">
                            <thead>
                                <tr>
                                    <th></th>
                                    <th>ชื่องาน</th>
                                    <th>วันครบกำหนด</th>
                                    <th>สถานะ</th>
                                    <th>ผู้รับผิดชอบ</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="subtaskTableBodyNew">
                                <% subtasks.forEach((subtask) => { %>
                                    <tr 
                                        class="task-row" 
                                        data-subtask-id="<%= subtask._id %>" 
                                        style="opacity: <%= subtask.subTask_status === 'เสร็จสิ้น' ? '0.5' : '1' %>;"
                                        onclick="showSubtaskFullView('<%= subtask._id %>')"
                                    >
                                        <td class="inputCheck">
                                            <input 
                                                type="checkbox" 
                                                class="checkbox" 
                                                <%= subtask.subTask_status === 'เสร็จสิ้น' ? 'checked' : '' %> 
                                                onchange="toggleSubtaskStatus('<%= subtask._id %>', this)" 
                                                onclick="event.stopPropagation()" 
                                            >
                                        </td>
                                        <td><%= subtask.subtask_Name %></td>
                                        <td><%= subtask.subTask_dueDate %></td>
                                        <td><div class="statusWrape"><%= subtask.subTask_status %></div></td>
                                        <td>
                                            <img src="<%= userImage %>">
                                            <%= userName %>
                                        </td>
                                        <td class="deleteSubtask" onclick="deleteSubtask('<%= subtask._id %>', this)">
                                            <i class="fa-solid fa-trash-can"></i>
                                        </td>
                                    </tr>
                                <% }) %>
                            </tbody>
                        </table>
                    </div>

                    <!-- Single Subtask Form -->
                    <form action="/addSubtask" id="subtaskFormMainNew" style="display: none;">
                        <input type="text" id="subtaskNameInputMainNew" placeholder="เพิ่มงานย่อยที่คุณต้องการทำให้เสร็จสิ้นเลย" required>
                    
                        <!-- Assignee input -->
                        <div class="assigneeInputNew" id="assigneeWrapper">
                            <a class="assignee-nav-link dropdown-toggle" id="individual-space-dropdown-main" role="button" aria-expanded="false">
                                <i class="fa-solid fa-circle-user"></i>
                            </a>
                            <ul class="dropdown-menu" aria-labelledby="individual-space-dropdown-main" id="assigneeInput">
                                <li><a class="dropdown-item" data-username="User 1" data-userimg="/pic/images.jpeg" href="#"><img src="/pic/images.jpeg" alt="User 1"> User 1</a></li>
                                <li><a class="dropdown-item" data-username="User 2" data-userimg="/pic/NKZ_7411.JPG" href="#"><img src="/pic/NKZ_7411.JPG" alt="User 2"> User 2</a></li>
                            </ul>
                            <div class="selected-assignees" id="selectedAssignees"></div>
                        </div>
                    
                        <!-- Due date input -->
                        <div class="dueDateInputNew" id="dueDateWrapper">
                            <i class="fa-regular fa-calendar-check" id="calendarIcon"></i>
                            <input type="text" id="dueDateInputNew" required>
                        </div>
                    
                        <!-- Buttons for the Form -->
                        <button type="button" id="cancelSubtaskNew">ยกเลิก</button>
                        <button type="button" id="addSubtaskNew">บันทึก</button>
                        <input type="hidden" name="taskId" id="taskId" value="<%= task._id %>">
                    </form>
                
                    <!-- Add Subtask Button (Initially visible when there's no data) -->
                    <button id="addSubtaskBtnMainNew" class="add-subtask-btn-detail">+ เพิ่มงานย่อยใหม่</button>
                </div>


                <!-- Full detail Page View -->
                <div class="full-page-view" id="fullPageView">
                    <div class="back-button">
                        <button onclick="closeFullView()"> 
                            <i class="fa-solid fa-arrow-left"></i>
                            กลับไปที่งาน
                        </button>
                    </div>
                    <div class="full-content">
                        <!-- Full content goes here -->
                        <h1 class="taskName" id="taskName-text">
                            <%= taskNames %> 
                        </h1>
                        <textarea name="taskDescription" id="taskDescription" placeholder="เพิ่มคำอธิบายของงานได้ที่นี่..."></textarea>
                    </div>
                </div>

                <!-- Subtask Full Page View -->
                <div class="full-subtask-page-view" id="fullPageViewSubtask" style="display: none;" data-subtask-id="">
                <div class="back-button">
                    <button onclick="closeSubtaskFullView()">
                        <i class="fa-solid fa-arrow-left"></i> กลับไปที่งาน
                    </button>
                    <button onclick="deleteSubtask()" class="deleteSub">
                        <i class="fa-solid fa-trash-can"></i> ลบงานย่อย
                    </button>
                </div>
                <div class="full-content">
                    <form id="updateSubtaskForm" action="/updateSubtask" method="POST">
                        <div class="nameSec">
                            <h1 class="SubtaskName" id="taskName-text">
                                <span id="subtaskNameText">subtask_Name</span>
                            </h1>
                            <input type="text" id="SubtaskName" name="SubtaskName" value="" style="display: none;" onblur="saveSubTaskName()">
                        </div>
                        <div class="SubTaskdetailSec">
                            <div class="grid-container">
                                <div class="grid-item topic">
                                    <div class="sub-detail-name"><i class="fa-solid fa-circle-half-stroke"></i> สถานะ</div>
                                    <div class="detail-data">
                                        <button type="button" class="status-btn" id="subtaskStatusText" onclick="toggleStatus()">กำลังทำ</button>
                                    </div>
                                </div>
                                <div class="grid-item topic">
                                    <div class="sub-detail-name"><i class="fa-regular fa-calendar-check"></i> วันครบกำหนด</div>
                                    <div class="sub-detail-data" id="subtaskDueDateText">subTask_dueDate</div>
                                </div>
                                <div class="grid-item topic">
                                    <div class="sub-detail-name"><i class="fa-regular fa-circle-user"></i> ผู้รับผิดชอบ</div>
                                    <div class="sub-detail-data">
                                        <img src="<%= userImage %>">
                                            <%= userName %>
                                    </div>
                                </div>
                            </div>
                            <div class="SubDescription-box">
                                <textarea name="subtaskDescription" id="subtaskDescription" placeholder="เพิ่มคำอธิบายของงานได้ที่นี่..."></textarea>
                            </div>
                            <input type="hidden" id="subtaskId" name="subtaskId" value="">
                        </div>
                    </form>
                </div>
            </div>

            </div>

            <div class="activity">
                    <div class="textTopic"> <h1>กิจกรรมที่เกิดขึ้น</h1> </div>

                    <div class="messageAct">
                        <div class="activityUpdate">
                            <% task.activityLogs.forEach(log=> { %>
                                <p class="log"> <%= log %> </p>   
                            <% }) %>
                        </div>
                </div>
            </div>
        </div>
        
        

    </div>

    <script>
        // Function to assign icons based on file type
        function setFileIcons() {
            const fileItems = document.querySelectorAll('#fileItemlist li');
        
            fileItems.forEach(item => {
            const iconElement = item.querySelector('.file-icon'); // Target the icon element
            const fileName = item.querySelector('span').innerText.toLowerCase(); // Get the file name
        
            if (fileName.endsWith('.pdf')) {
                iconElement.className = 'fa-solid fa-file-pdf'; // Set PDF icon
                iconElement.style.color = '#e74c3c'; // Red color for PDFs
            } else if (fileName.endsWith('.doc') || fileName.endsWith('.docx')) {
                iconElement.className = 'fa-solid fa-file-word'; // Set Word icon
                iconElement.style.color = '#2e86de'; // Blue color for Word docs
            } else if (fileName.endsWith('.jpg') || fileName.endsWith('.jpeg') || fileName.endsWith('.png')) {
                iconElement.className = 'fa-solid fa-file-image'; // Set Image icon
                iconElement.style.color = '#27ae60'; // Green color for images
            } else {
                iconElement.className = 'fa-solid fa-file'; // Default file icon
                iconElement.style.color = '#7f8c8d'; // Grey color for unknown types
            }
            });
        }
        
        // Call the function when the page loads
        document.addEventListener('DOMContentLoaded', setFileIcons);

  
        const fileUpload = document.getElementById('fileUpload');
        const fileName = document.getElementById('fileName');

        fileUpload.addEventListener('change', (event) => {
        const files = event.target.files;
        if (files.length > 0) {
            fileName.textContent = Array.from(files).map(file => file.name).join(', ');
        } else {
            fileName.textContent = 'ไม่ได้เลือกไฟล์ใด';
        }
        });

        document.addEventListener('DOMContentLoaded', () => {
            const statusDiv = document.querySelector('.status-div');
            const statusText = statusDiv.getAttribute('data-status');
            const spinnerIcon = statusDiv.querySelector('.spinner-icon');
        
            console.log('Status:', statusText);  // Check what status is received
        
            switch (statusText) {
                case 'กำลังทำ': // In Progress
                    statusDiv.style.backgroundColor = '#6EACDA';
                    break;
        
                case 'รอตรวจ': // Pending
                    statusDiv.style.backgroundColor = '#919191';
                    spinnerIcon.style.display = 'inline'; // Show spinner icon
                    break;
        
                case 'แก้ไข': // Edited
                    statusDiv.style.backgroundColor = '#FF4C4C';
                    break;
        
                case 'เสร็จสิ้น': // Completed
                    statusDiv.style.backgroundColor = '#4CAF50';
                    break;
        
                default:
                    console.warn('Unhandled status:', statusText); // Warn for any unhandled status
                    statusDiv.style.backgroundColor = '#FFFFFF'; // Optional default color
            }
        });
    </script>
</body>